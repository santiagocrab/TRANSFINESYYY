<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:include="layout :: layout">
<body>
    <th:block th:fragment="content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-cash-coin"></i>
                Payments
            </h1>
        </div>

        <div th:if="${successMessage}" class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-error">
            <i class="bi bi-exclamation-circle"></i>
            <span th:text="${errorMessage}"></span>
        </div>

        <!-- Payment Form -->
        <div class="card mb-xl">
            <div class="card-header">
                <h3 class="card-title">Record Payment</h3>
            </div>
            <div class="card-body">
                <form th:action="@{/payments/save}" method="post" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: var(--spacing-md); align-items: end;">
                    <div class="form-group" style="position: relative;">
                        <label class="form-label">Student</label>
                        <input type="text" id="studentSearch" class="form-control" 
                               placeholder="Search by Student ID, Name, or RFID..." 
                               autocomplete="off" required>
                        <input type="hidden" name="studentId" id="studentId" required>
                        <div id="studentDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (₱)</label>
                        <input type="number" name="amount" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">OR Number</label>
                        <input type="text" name="orNumber" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" th:value="${today}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i>
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search -->
        <div class="search-section mb-xl">
            <form th:action="@{/payments}" method="get" class="search-row">
                <div class="form-group">
                    <label class="form-label">Search By</label>
                    <select name="searchType" class="form-select">
                        <option value="All Fields" th:selected="${searchType == 'All Fields'}">All Fields</option>
                        <option value="Student ID" th:selected="${searchType == 'Student ID'}">Student ID</option>
                        <option value="Student Name" th:selected="${searchType == 'Student Name'}">Student Name</option>
                        <option value="OR Number" th:selected="${searchType == 'OR Number'}">OR Number</option>
                        <option value="Payment ID" th:selected="${searchType == 'Payment ID'}">Payment ID</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Query</label>
                    <input type="text" name="search" class="form-control" th:value="${search}" placeholder="Enter search term...">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a th:href="@{/payments}" class="btn btn-secondary" style="margin-left: var(--spacing-sm);">Clear</a>
                </div>
            </form>
        </div>

        <!-- Payments Table -->
        <div class="card">
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Payment ID</th>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Course</th>
                            <th>Year</th>
                            <th>Section</th>
                            <th>Amount</th>
                            <th>OR Number</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${payments.isEmpty()}">
                            <td colspan="9" style="text-align: center; padding: var(--spacing-xl); color: #6B7280;">No payments found.</td>
                        </tr>
                        <tr th:each="payment : ${payments}" th:with="student=${studentMap.get(payment.studID)}">
                            <td th:text="${payment.paymentID}">PAY001</td>
                            <td th:text="${payment.studID}">STUD001</td>
                            <td th:text="${student != null ? student.fullName : payment.studID}">Student Name</td>
                            <td th:text="${student != null ? student.course : 'N/A'}">BSIT</td>
                            <td th:text="${student != null ? student.yearLevel : 'N/A'}">1</td>
                            <td th:text="${student != null ? student.section : 'N/A'}">A</td>
                            <td style="font-weight: 600; color: var(--success);" th:text="'₱' + ${#numbers.formatDecimal(payment.amount, 1, 2)}">₱0.00</td>
                            <td th:text="${payment.orNumber}">OR001</td>
                            <td th:text="${#temporals.format(payment.date, 'yyyy-MM-dd')}">2025-01-01</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            const studentSearch = document.getElementById('studentSearch');
            const studentId = document.getElementById('studentId');
            const studentDropdown = document.getElementById('studentDropdown');
            let searchTimeout;

            studentSearch.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    studentDropdown.style.display = 'none';
                    studentId.value = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch('/students/search?query=' + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            studentDropdown.innerHTML = '';
                            if (data.length === 0) {
                                studentDropdown.innerHTML = '<div style="padding: 10px; color: #666;">No students found</div>';
                                studentDropdown.style.display = 'block';
                            } else {
                                data.forEach(student => {
                                    const div = document.createElement('div');
                                    div.style.padding = '10px';
                                    div.style.cursor = 'pointer';
                                    div.style.borderBottom = '1px solid #eee';
                                    div.textContent = student.display;
                                    div.addEventListener('mouseenter', function() {
                                        this.style.background = '#f5f5f5';
                                    });
                                    div.addEventListener('mouseleave', function() {
                                        this.style.background = 'white';
                                    });
                                    div.addEventListener('click', function() {
                                        studentSearch.value = student.display;
                                        studentId.value = student.studID;
                                        studentDropdown.style.display = 'none';
                                    });
                                    studentDropdown.appendChild(div);
                                });
                                studentDropdown.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching students:', error);
                        });
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!studentSearch.contains(e.target) && !studentDropdown.contains(e.target)) {
                    studentDropdown.style.display = 'none';
                }
            });
        </script>
    </th:block>
</body>
</html>
